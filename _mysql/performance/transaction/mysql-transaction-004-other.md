---
title: "MySQL 其它"
sequence: "107"
---

## 什么是事务？

事务就是一组独立不可分割的工作单元，事务中的操作要么全部执行成功，要么全部执行失败，没有其他的中间状态。

具体地说，就是在一个事务中执行多个操作时，要么所有的事务都被提交（commit），那么这些修改就永久保存下来；
要么数据库放弃所做的所有修改，整个事务回滚（rollback）到最初状态。

## 事务的四大特性

事务的四个特性分别是：原子性、一致性、隔离性和持久性，即所谓的 ACID。

原子性：将事务看作是不可再分的原子，一旦开始事务，要么全部执行，要么全部取消，是不存在中间状态的。即把一个事务看成一个整体，牵一发而动全身。

一致性：在事务开始之前和之后，数据从一个合法性状态变换到另一个合法性状态，数据库的完整性约束没有被破坏。
例如：买早餐，顾客付了 10 块钱。老板收到了 10 块钱（这里不考虑手续费的问题），顾客和老板加起来的总额不会变化，不多也不少。

隔离性：每个读写事务对其他事务的操作对象能相互分离。例如事务 T1 和事务 T2 的操作不能相互干扰。

持久性：事务一旦提交，它对数据库中数据的改变就是永久性，接下来的其他操作和数据库故障不应该对其有任何影响。
持久性是通过事务日志来保证的。日志包括了重做日志和回滚日志。

## 事务的实现

在介绍存储引擎的时候，也说到了 InnoDB 是支持事务的，那么接下来我们就以 InnoDB 为例来说明。

数据库通常借助日志来实现事务，常见的有 undo log 和 redo log，这两种都能保证事务特性，undo log 实现事务原子性，redo log 实现事务的持久性。

### redo log(重做日志)

每当操作时，在磁盘数据变更之前，将操作写入 redo log，这样当系统崩溃重启后可以继续执行。

#### redolog 的作用

MySQL 在 innodb 引擎下，所做的增删改查都是先去 buffer pool 缓冲池（内存区域）里面操作，然后再把数据写入磁盘，
因为增删改都是在内存操作，这样就存在系统异常导致数据丢失的情况，redolog 就是为了解决系统异常导致内存修改丢失的问题。

#### redolog 如何保证数据不丢失

所有的操作都是以事务为单位的，在事务未执行完毕的时候数据库异常导致数据丢失是正常的，因为事务未提交成功。
在事务提交的时候，我们把 redolog 从内存刷入到磁盘中去，从而保证修改不丢失，如果写入磁盘失败，那事务也将提交失败。

#### 为什么不直接把修改更新到磁盘？

MySQL 操作数据是在内存中完成的，然后再把内存中的数据页写入到磁盘中。不直接操作磁盘目的就是为了提高性能。
虽然 redolog 落盘的时候也是入磁盘，但它是顺序写入，而直接对磁盘上数据修改是随机写入，顺序写的速度要远远快于随机写。

### undo log(回滚日志)

当一个事务执行一半无法继续执行时，可以根据回滚日志将之前的修改恢复到变更之前的状态。undo log 是 innodb 实现，
总的来说提供两个作用：回滚和多版本控制 (MVCC)。

是事务特性的重要组成部分，在数据发生更新操作时候（INSERT、DELETE、UPDATE）时会产生 undo 记录。
**先于 redo log 被记录**。

## Reference

- [系统地认识开源的MySQL数据库](https://baijiahao.baidu.com/s?id=1744842112462859099)

