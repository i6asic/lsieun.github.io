---
title: "APM Concept"
sequence: "102"
---

## QPS

QPS 的全称是 Queries Per Second，指的是每秒查询率。
在计算机系统中，QPS 表示在单位时间内系统能够处理的请求数，通常用于衡量系统的性能和容量。

在 Web 应用程序中，QPS 是指在一秒钟内，服务器可以处理的 HTTP 请求的数量，这通常是一个很重要的指标，反映了服务器的负载能力和响应速度。
以电商网站为例，一个高峰期的 QPS 的值可能会非常高，需要系统具备足够的负载能力才能满足用户需求。

在数据库系统中，QPS 通常用来衡量数据库的吞吐量。
例如，在高并发请求下，相同硬件条件下的 MySQL 数据库，每秒能够处理的查询语句数量就可以用 QPS 来衡量。
通过掌握 QPS 指标，可以更好地为系统的架构设计、硬件资源配置和软件优化提供参考依据。

需要注意的是，QPS 并不完全代表系统的性能，还需要考虑诸如请求时间、失败率、错误处理和安全性等问题。
同时，QPS 还可能受到系统和网络环境等外部因素的影响。因此，在进行性能优化时，需要多维度地考虑，综合分析系统的整体状况进行优化。

## TPS

TPS 的全称是 Transactions Per Second，表示每秒事务数，通常用于衡量事务处理系统的容量、性能以及稳定性等方面的指标。

在计算机系统中，一个事务通常包括一个或多个操作，例如读取或更新数据。
在数据库等系统中，TPS 可以衡量系统的吞吐量和响应时间，以评估系统的性能和容量。
例如，在高并发请求下，数据库每秒能够处理的事务数量将直接影响系统的响应时间和客户体验，
因此，对于许多在线交易应用程序而言，TPS 是一种重要的性能指标。

尽管 TPS 通常用于评估事务处理系统的性能，但它也可以用于其他类型的系统。
例如，在分布式系统中，可以用 TPS 来衡量系统的事务处理能力和可扩展性。

需要注意的是，TPS 与 QPS 之间存在一定的区别。
QPS 通常用于计算每秒的请求或查询次数，而 TPS 则将一个具有完整并成功执行的事务计算为一次处理。
因此，如果一个事务包含多次查询或更新操作，则其 TPS 值可能会低于 QPS 值。

## 不同维度

- 操作系统：
    - 资源占用率（CPU、IO），有些是 IO 密集型、有些是 CPU 密集型程序
    - 网络使用情况：丢包率
- JVM 层面
- 应用层面
- 业务层面的统计：营收系统，成交多个工单


- 统计指标（Metrics），是一个压缩后的数值

- 链路追踪（Tracing）

不同级别：

- 请求级别：链路追踪
- 聚合级别：日志和统计指标

## 日志

日志级别、日志的来源、日志的内容

不同层面：

- 前端：Web、App、小程序
- 网关：Nginx、Kong、Spring Cloud Gateway
- 应用
    - 基于容器托管（Tomcat）：容器启动日志、请求访问日志
    - 普通应用
- 组件层：
    - MySQL - Redis
    - 应用运行时产生的日志
    - 慢查询日志
    - 审计日志
- 基础层（偏向运维）
    - 系统日志
    - 操作日志

- 日志编写方式
    - 日志开发时
        - 日志编写位置
            - 系统/应用启动和参数变更
            - 关键操作节点
            - 大型任务进度上报
            - 异常
        - 写入性能
            - 日志编写位置
            - 日志数量
            - 日志编写等级
            - 日志输出级别
            - 无用输出参数
        - 占位符
        - 可读性
            - 会话标识
            - 请求标识
            - 参数信息
            - 发生数据的结果
        - 关键信息隐藏
            - 对于关键的信息不显示或者进行掩码处理，以防泄露
    - 开发完成后
        - 减少代码位置信息的输出
        - 文件分类
            - 将不同的业务逻辑按照不同的日志文件来分类
        - 日志 Review

日志格式

- 系统之间的格式保持一致
- 不编写多行的日志内容
- 不使用日志中常见内容来分隔

日志归档

- 每天生成一个日志文件

## 统计指标

指标类型：

- 计数器（Counter）
- 仪表盘（Gauge）
- 直方图（Histogram）

## TP99

在“TP99”这个词组中，“TP”是“Throughput”的缩写，表示吞吐量或处理速率的意思。
因此，“TP99”指的是处理速率的一个特定百分位数，即在一组数据中，前 99% 的数据处理时间所对应的最大值。
通过 TP99 的值，可以评估系统对高负载情况的处理能力，提高系统的性能和稳定性，同时优化用户的体验。

常见指标：

- QPS
- SLA
- Apdex = Application Performance Index
    - Satisfactory
    - Tolerating
    - Frustrating

## 监控指标

- 监控指标
    - 端上访问
        - APP
            - 崩溃率
            - 卡顿率：UI 刷新时出现卡顿的情况
            - 卸载率
        - 网页
            - 白屏时间：从用户输入地址栏到首次出现内容的时间
            - 首屏时间
        - 通用指标
            - NDS 寻找
                - DNS 响应时间
            - 建立与服务器的连接
                - 建立连接时间
                - SSL 握手时间
                - 首字节时间
                - 下载内容时间
            - 发送请求
            - 请求响应
    - 应用程序
        - 请求
            - QPS：请求数量
            - 状态码：2XX 成功，3XX 业务边界，4XX 客户端有问题，5XX 服务端有问题
            - 请求时间：响应耗时
            - SLA
            - 独立用户数：用户数越多，产品
        - 数据处理
            - RPC
            - 消费者成功率
            - 熔断限流降级
        - 组件协作资源
            - 数据源：MySQL、MongoDB
        - 业务指标
        - VM
    - 组件
    - 机器信息

第三方资源利用：

- RPC
- 数据库
- 队列
    - 发送量
    - 处理量
    - Lag 值
    - 处理耗时
- 缓存：Redis
    - 命中率
    - 内存使用率
    - 数据量
- 请求
    - HTTP 请求
    - 熔断降级策略

JVM

- GC：GC 次数
- 内存：年轻代、老年代、堆处、Meta 区
- CPU 占用率
- 类加载：加载数量
- 线程

组件，是数据最终存储的位置，也是数据中转的地方

- 数据库：
    - QPS
    - 查询耗时：增加索引
    - TPS
    - 主从延迟数
    - 连接数：连接数高，则可能造成数据库处理缓慢
    - 数据量：单个表的数据量，大于某个数值，则会出现性能问题
    - VM 监控：某些组件是基于某种语言开发，例如 ES 是基于 Java 开发，因此也需要监控 JVM
- 队列
    - Lag 值
    - 发送量
    - 消费数量
    - 分区数量
    - 处理耗时
- 缓存
    - 响应时间
    - 缓存命中率
    - 网络延迟时间
    - 已使用内存
    - 资源连接
    - 缓存数量
- 网关层
    - 请求相关
        - QPS
        - 请求耗时
        - 状态码
        - 等等
    - 错误数
    - 请求处理

机器信息

- CPU
    - 系统整体使用率
        - 系统侧
        - 用户侧
- 内存
    - 内存大小
    - SWAP 区
- 磁盘
    - 使用率
- 网络
    - 出入流量
    - 丢包率
    - 连接错误数
- I/O
    - 读取/写入速度
    - 耗时
    - 次数
    - 使用率
- 句柄
    - 句柄的使用量

## 指标编写

- 产品层（业务数据）
- 性能层（性能数据）
    - 操作行为
        - 关键路径
        - 处理流程：获取用户信息、订单、购买、平均成单时间
        - 触发行为：
    - 自定义数据处理
        - 队列
            - 放入的数据个数
            - 队列剩余任务数
        - 线程池
            - Fix 模式
            - Cache 模式
    - 定时/大任务处理
        - 处理过程
        - 处理结果：处理耗时、处理次数
    - 第三方服务端对接
        - 调用次数
        - 调用时长/错误次数
    - 执行异常


- Acquisition 获客
- Activation 激活
- Retention 留存
- Revenue 获利
- Referral 推荐

指标函数，一般都是与“时间”相关的

- 当前时间段的计算
    - avg
    - max/min
    - count
    - apdex
    - histogram
    - percentile
    - percent
    - sum
- 与之前的指标进行计算
    - rate：增长率
    - irate：只计算最近两次
    - 环比
    - 同比

## 链路监控

- Span
    - 时间
        - 开始时间
        - 结束时间
    - 层级关系
        - ID
        - 父级 ID
    - 操作
        - 操作名称
        - 操作类型
            - 出口
            - 本地
            - 出口
- Span 与 Span 的关系
    - 一个入口可能有多个出口操作

链路追踪 与 Dapper

链路追踪的作用：

- 链路查询
- 性能分析
- 拓扑图
- 依赖关系
- 跨应用/语言

采样率

- 只采集一部分的链路信息，从而提升程序性能

链路追踪的短板

- 代码埋点
- 字节码增强

链路分析

- 统计指标：指标聚合
    - 服务
    - 实例
    - 端点
    - 指标聚合
        - QPS
        - SLA
        - 耗时
        - Apdex
        - Percentile
        - Histogram
        - 延迟
        - topN
- 拓扑图
    - 可视化
    - 数据化
    - 动态化（时间维度）
- 数据定制化

## 性能剖析

## 链路分析

## 日志收集

- 日志收集
- 日志解析
- 日志存储
- 日志检索

- Logstash 充当了日志采集和日志解析工作
- Elasticsearch 用于数据存储
- Kibana 用于数据检索
- Filebeat 可以替代 Logstash，它可以轻量化地部署在每一个服务容器中，使用较少的资源，就可以实现数据采集的工作

## ZipKin

链路采集

- 性能损耗
    - 采集器对服务的影响尽可能做到最小
    - 无论是埋点，还字节码增强，都存在一定的性能损耗
- 代码侵入
    - 接入方式越简单越好
    - 埋点，可能存在一定的代码级侵入性
    - 字节码增强的依赖性更低
- 开发难易程度
    - 埋点开发相对来说较为简单，但不太方便进行链路追踪
    - 字节码增强的开发难度相对较高，但也更灵活一些
- 可扩展性
    - 一个优秀的链路追踪系统，在链路采集的层面一定会有良好的扩展性，而不是仅适用于单独的一个业务或者框架

数据收集

- 从链路采集到数据之后，就对这些数据进行解析、分析等工作，并最终存储到相应的存储引擎中

数据查看


