---
title: "sysctl"
sequence: "sysctl"
---

[UP](/linux.html)


## 介绍

对于内核参数的修改，有两种方式：

- 临时修改：`sysctl` 命令对内核参数的修改仅在当前生效，重启系统后参数丢失。
- 永久修改：修改配置文件 `/etc/sysctl.conf`。

在内核运行时，`sysctl` 命令被用于动态地修改内核的运行参数，可用的内核参数在目录 `/proc/sys` 中。

它包含一些 TCP/IP 堆栈和虚拟内存系统的高级选项，这可以让有经验的管理员提高引人注目的系统性能。
用 sysctl 可以读取设置超过五百个系统变量。

## 语法

语法格式

```text
sysctl [参数]
```

常用参数：

- `-n`：打印值时不打印关键字
- `-e`：忽略未知关键字错误
- `-N`：仅打印名称
- `-w`：当改变 sysctl 设置时使用此项
- `-p`：从配置文件 `/etc/sysctl.conf` 加载内核参数设置
- `-a`：打印当前所有可用的内核参数变量和值
- `-A`：以表格方式打印当前所有可用的内核参数变量和值

## 参考示例

查看所有可读变量：

```text
sysctl -a
```

读一个指定的变量：

```text
$ sysctl net.ipv6.neigh.lo.locktime
net.ipv6.neigh.lo.locktime = 0
```

修改指定变量的值：

```text
$ sudo sysctl -w net.ipv6.neigh.lo.locktime=1
```

## vm

### vm.max_map_count

`vm.max_map_count`: This is a system limit in the Linux kernel that
sets the maximum number of **memory map areas** a process may have.

什么是 memory map area 呢？

内存映射区（Memory map area）是指操作系统中用于管理**进程地址空间**与**物理内存**之间映射关系的一种数据结构。
当进程需要访问文件或设备时，可以通过内存映射将这些资源映射到其地址空间中，使得进程可以像访问内存一样访问这些资源，从而简化了对资源的访问。
内存映射也可以用于共享内存、动态链接库加载和虚拟内存管理等方面。

在 Linux 系统中，**内存映射区**由虚拟文件系统 VFS 和内核管理。
每个进程拥有自己的内存映射区，用于管理其所需资源的映射关系，而 `vm.max_map_count` 参数则控制了一个进程可以拥有的最大内存映射区的数量。

### vm.overcommit_memory

`vm.overcommit_memory` 是 Linux 内核中的一个参数，用于控制 Linux 系统在内存过度分配时的行为。

```text
$ sudo sysctl vm.overcommit_memory=1
```

该参数有三个可能的值:

- `0` 表示内核会考虑进程所请求的内存数量和系统的可用内存数量来进行内存分配，通过计算来预留允许的内存，但不会真正分配，这是**默认的设置**。
- `1` 表示内核会**允许超额分配内存**，即使系统实际物理内存已经不足。
- `2` 表示内核会拒绝任何新的内存映射申请或不允许进程使用大页内存，这个设置实际上是在不允许任何超额的内存分配。

该参数的设置涉及 Linux 系统内存管理策略，使用时需要谨慎，根据实际情况选择合适的值以平衡系统的性能和稳定性。

## net

### net.core.somaxconn

`net.core.somaxconn` 是一个用于调整 Linux 内核参数的设置，它控制了服务器端允许的最大连接请求数量。

这个参数指定了服务端监听套接字的最大连接队列长度。
当服务器接收到连接请求时，如果连接队列已满，则客户端会收到连接拒绝错误。
通过增加 `net.core.somaxconn` 可以提高服务器处理连接请求的能力，特别是在高负载的网络环境中。

默认情况下，`net.core.somaxconn` 的值是 `128`，通常情况下这个值已经足够了。
但在某些情况下，比如高负载的网络或者大量的短连接请求时，可能需要增加这个值来提高服务器的性能。

### net.ipv4.ip_forward

`net.ipv4.ip_forward` 是一个 Linux 系统内核参数，用于控制 IP 包的转发功能。

当 `net.ipv4.ip_forward` 被设置为 `1` 时，表示系统允许将收到的 IP 数据包转发到其他网络接口上。
这在作为路由器或网关的系统上是非常有用的，因为它允许系统将数据包从一个网络接口路由到另一个网络接口，而不仅仅是处理发往自己的数据包。

当 `net.ipv4.ip_forward` 被设置为 `0` 时，系统将禁止 IP 数据包的转发功能，而且这也是大多数系统的默认设置，
因为大多数系统都不会作为路由器来使用。
因此，在需要将 Linux 系统配置为路由器或网关的情况下，需要修改这个参数为 1。

值得注意的是，修改 `net.ipv4.ip_forward` 参数需要权限，通常需要 root 权限才能进行修改，并且在配置路由器或网关的过程中，
还需要注意安全性和网络策略的设置，以免受到未经授权的访问或不必要的数据包转发。

## fs

### fs.file-max

`fs.file-max` 是 Linux 系统内核参数之一，它控制了整个系统所允许打开的文件的最大数量。
当应用程序需要打开文件时，会消耗系统的文件描述符。
如果系统中的文件描述符数量达到了这个限制，那么将无法再打开更多的文件，即使系统中还有足够的空间。

通过调整 `fs.file-max` 参数，可以提高系统对文件的并发处理能力，特别是在高负载或需要大量文件操作的场景中，例如 Web 服务器或数据库服务器。
默认情况下，这个值相对较小，通常情况下需要根据实际情况进行调整。

```text
$ sysctl fs.file-max
fs.file-max = 196150
```

值得注意的是，修改 `fs.file-max` 需要谨慎，确保调整后的值不会超出系统的承受范围，以免出现系统资源不足导致性能下降或者系统崩溃的情况。
