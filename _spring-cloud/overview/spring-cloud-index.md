---
title: "Spring Cloud"
sequence: "111"
---

Spring Cloud为开发者提供了一套快速开发分布式系统的组件。

## 核心概念

- 配置中心
- 注册中心（服务注册与发现）
- 服务网关
- 负载均衡
- RPC调用
- 服务熔断
- 服务降级
- 服务限流
- 全局锁
- 控制总线
- 分布式事务
- 服务安全
- 链路追踪
- 集群管理
- 事件驱动
- 任务调度
- 云连接器
- 函数计算
- 服务消息队列
- 服务监控
- 全链路追踪
- 自动化构建部署
- 服务定时任务调度操作

## 配置中心

分布式配置中心的特点

- 统一管理：配置服务端+配置客户端
- 区分环境：（开发、测试、生产）
- 实时刷新：更新机制，配置中心服务端的**配置发生了变化时**，配置中心的客户端需要能实时监听到配置的改变
- 权限控制：针对不同的角色或用户设置对应的权限
- 版本控制：在使用配置中心的过程中，难免会出现**误操作**，这个时候，就需要进行版本回退
- 灰度发布：将配置发布到**部分实例**进行测试，待测试通过后，再发布到**全部实例**，这就是配置的**灰度发布**。

常用的配置中心组件：

- Spring Cloud Config
- 阿里Nacos
- 携程Apollo
- 谷歌consul

## 分布式注册中心

什么是注册中心？

注册中心相当于微服务架构中的地址通讯录。
每个微服务会将服务及其地址注册到注册中心，
服务消费者在调用某个微服务之前会先从**注册中心**查找服务地址，然后进行调用。

```text
微服务 --> 注册中心 --> 服务消费者
```

注册中心的特点

- 服务的自动注册：微服务应用在启动时，通过注册中心客户端组件，将服务相关信息自动注册给注册中心服务端。
- 服务的健康检查：当已经注册的注册中心的微服务实例down机后，注册中心服务端能发现实例已经down机，并把相关信息从注册中心删除掉
- 服务的自动发现：服务消费者需要能实时监听到注册中心中服务信息的变更，以便能真正调用服务时，不会出现错误

常见的注册中心组件

- Zookeeper
- Eureka
- Nacos
- Consul

## 服务网关

什么是服务网关？

服务网关是整个微服务架构中对外的统一入口。
所有的客户端都通过统一的网关使用微服务。
服务网关起到了隔离外部访问和内部系统的作用，
服务网关是微服务架构中的一个标配组件。

服务网关的特点

- 高并发：作为微服务架构中的对外入口，必须能支持高并发，并承担更高的并发量，并保证高性能。
- 安全：服务网关通常具有权限认证、黑名单、白名单等保证网关安全的功能。
- 路由转发：服务网关接收到外部请求后，要求服务网关能够根据请求和配置，将请求转发到对应的后端微服务上去。
- 监控与限流：作为整个系统的流量入口，服务网关要能监控流量情况，遇到突发情况时，能及时限流，保证整个系统的稳定。
- 灰度发布：当某个微服务有新版本更新上线时，可以利用服务网关进行流量切换，实现该微服务的灰度发布。
- 服务重试：当服务网关调用某个微服务失败后，可以通过服务网关设置重试策略，来重新尝试调用该服务。
- 服务别名：可以在服务网关中给某个或某些微服务设置别名，从而对外屏蔽内部微服务相关信息。

常见服务网关组件：

- Kong
- Zuul
- Spring Cloud Gateway

## 负载均衡

什么是负载均衡？

负载均衡是指将访问流量根据负载均衡算法分发到后端服务器的流量分发控制服务。
通过负载均衡可以提高微服务的可用性以及性能。

常用负载均衡算法

- 简单轮询：将请求按顺序分发给后端服务器上，不关心服务器当前状态，比如后端服务器的性能、当前的负载
- 加权轮询：根据服务器自身的性能给服务器设置不同的权重，将请求按顺序和权重分发给后端服务器，可以让性能高的机器处理更多的请求。
- 简单随机：将请求随机发给后端服务器上，请求越多，各个服务器接收到的请求越平均。
- 加权随机：根据服务器自身的性能给服务器设置不同的权重，将请求按各个服务器的权重随机发给后端服务器。
- 一致性哈希：根据请求的客户端IP或请求参数通过哈希算法得到一个数值，利用该数值取模映射出对应的后端服务器。这样能保证同一个客户端或相同参数的请求每次都使用同一台服务器。
- 最小活跃数：统计每台服务器上当前正在处理的请求数，也就是请求活跃数，将请求分发给活跃数最少的后台服务器。

常见负载均衡组件：

- Nginx
- lvs
- ribbon

## RPC调用

什么是RPC调用？

RPC就是远程过程调用。
对于Java程序而言，RPC就是远程方法调用，表示一个方法调用远程的另一个方法。
微服务架构中一个服务调用另外一个服务，就可以用RPC调用。

RPC调用与HTTP调用区别

- HTTP调用使用的是HTTP协议，是网络7层中的**应用层**协议。HTTP协议规定了数据传输的格式，RESTful风格就可以通过HTTP协议来实现
- RPC不是网络层面的协议，而是更上层的、更灵活的通信协议。RPC调用可以自定义数据格式、数据传输方式，只要能保证调用到远程方法即可。

常用的RPC调用组件或框架：

- Dubbo
- gRPC
- Thrift
- Feign

## 服务熔断

什么是服务熔断？

服务熔断是指，当服务A调用的某个服务B不可用时，上游服务A为了保证自己不受影响，
从而不再调用服务B，直接返回一个结果，减轻服务A和服务B的压力，直到服务B恢复。

什么是熔断器？

实现熔断功能的叫熔断器，代表组件为Hystrix、Sentinel

熔断器的三种状态

- Closed：关闭状态。当调用失败次数达到阈值时，则启动熔断器。
- Open：打开状态。此时，不会真正的调用下游服务，而是直接返回，当过了某段时间后，熔断器会进入到半打开状态。
- Half-Open：半打开状态。此时会有部分请求访问下游服务，如果这些请求都测试成功了，则认为下游服务恢复了，那么则关闭熔断器，否则熔断器回到打开状态。

## 服务降级

什么是服务降级？

服务降级是指，当发现系统压力过载时，可能通过关闭某个服务，
或限流某个服务来减轻系统压力，这就是服务降级。

服务降级与服务熔断的区别：

- 都是为了防止系统崩溃
- 都让用户体验到某些功能暂时不可用
- 熔断是下游服务故障触发的，降级是为了降低系统负载。

什么是服务雪崩？

服务A调用服务B，服务B调用服务C，此时大量请求突然调用服务A。
假如服务A本身能抗住这些请求，但是服务C抗不住，导致服务C请求堆积，
从而服务B请求堆积，从而服务A不可用，这就是服务雪崩。
解决方式是**服务降级**和**服务熔断**。

## 服务限流

服务限流是指在高并发请求下，为了保护系统，
可以对访问服务的请求进行数量上的限制，
从而防止系统不被大量请求压垮。
在秒杀中，限流是非常重要的。

常用的限流算法

- 固定窗口计数器
- 滑动窗口计数器
- 令牌桶
- 漏桶

## 全局锁

什么是全局锁？

全局锁，就是我们常说的分布式锁，
是分布式、微服务架构中的一种锁机制，
通过全局锁可以很好的在分布式系统中互斥使用共享资源。

全局锁的实现原理：

- Zookeeper：利用Zookeeper的watch机制与临时节点特性
- Redis：利用Redis的消费订阅机制与数据超时特性

常用的全局锁实现组件：

- Redisson
- Curator

## 控制总线

什么是控制总线？

控制总线也称消息总线，是微服务系统中用来连接系统中所有服务节点的，
微服务中的所有服务节点可以通过控制总线来进行通讯。

控制总线的应用场景

目前，Spring Cloud Bus就是控制总线的具体实现，
某个微服务可以通过Spring Cloud Bus来广播事件，
而其他微服务可以接收到事件并进行相关处理。

## 分布式事务

什么是分布式事务？

在一次请求中，所涉及的分散在多个微服务上的操作要保证同时成功或同时失败，这就是分布式事务。
比如创建订单减库存、银行转账等。

实现分布式事务的方式：

- 直接通过数据库
- 通过消息队列
- 两阶段提交
- 三阶段提交

分布式事务中的三个角色：

- 事务协调器
- 事务管理者
- 资源管理者

常见的分布式事务框架

- seata
- Icn
- bytetcc

## 服务安全

什么是服务安全？

对于一个企业来说，微服务系统中的服务安全性越来越重要，服务的认证和授权是企业必须具备的。
Spring Cloud Security是Spring Cloud提供的微服务安全组件。

服务安全的特性：

- 可扩展、可配置的认证和授权
- 单点登录
- 防止会话固定、点击劫持、跨网站请求伪造等攻击
- 与Servlet API集成

## 链路追踪

什么是链路追踪？

链路追踪为微服务系统提供了完整的调用链路还原、
调用请求量统计、链路拓扑、应用依赖分析等功能，
可以帮助开发者快速分析和诊断微服务架构下的性能瓶颈。

链路追踪的功能

- 分布式调用链查询和诊断
- 应用性能实时汇总
- 分布式拓扑动态发现
- 多语言开发程序接入
- 丰富的下游对接场景

常用的链路追踪的技术

- Sleuth
- Zipkin

## 集群管理

什么是集群管理？

集群管理是指，对于微服务系统中的某个服务集群所提供的针对集群管理的功能。
Spring Cloud Cluster的职责就是集群管理。

集群管理有哪些功能？

- 领导者选举
- 一致性存储
- 集群状态管理
- 一次性tokens

## 事件驱动

什么是事件驱动？

事件驱动就是消息驱动。
在Spring Cloud中提供了Spring Cloud Stream来实现事件驱动。
有了事件驱动，在微服务系统中可以更方便的通过发送消息来进行通信。

事件驱动中的概念：

- 目标绑定器，目标指的是kafka或rabbitmq
- 绑定桥梁，连接消息系统和应用程序
- 消息，应用程序和消息系统之间传递的数据

事件驱动的特点：

- 异步处理
- 流量削峰
- 服务解耦

## 云连接器

什么是云连接器？

云连接器可以用来方便的连接部署在云上的各种服务，
Spring Cloud中的Spring Cloud Connectors就是云连接器的组件实现。

目前支持的云平台：

- Spring Cloud Foundary
- Spring Cloud Heroku

## 函数计算

什么是函数计算？

函数计算也称为函数式编程，是实现Serverless的一种手段。
企业如果能使用函数计算，能大大节约成本，
在Spring Cloud中提供了Spring Cloud Function来开发基于云平台的函数计算。

函数计算的特点：

- 支持响应式等编程风格
- 输入输出类型透明化
- 流数据处理
- 同一个JVM中运行多版本函数
- 打包函数到指定云平台




## Reference

- [终于我把Spring、Spring Cloud 做成了通俗易懂的动画视频](https://www.bilibili.com/video/BV1ua411Y7wy?p=2)
- [查看Spring Cloud与Spring Boot的版本兼容性JSON格式](https://start.spring.io/actuator/info)
