---
title: "线程池：线程数量 + 阻塞队列大小设置多少合理"
sequence: "106"
---

[UP](/java-concurrency.html)


## 线程数量

- 如果线程数量过小，会导致程序不能充分地利用系统资源，容易导致饥饿
- 如果线程数量过大，会导致更多的线程上下文切换，占用更多内存

如何设置线程池的大小？

第一种：有具体的计算公式算出来

```text
线程数 = N * U * (1 + W/C)
```

- N = CPU 数量（可以理解为 CPU 核数，即同一时刻能并行处理线程的数量）
- U = 目标 CPU 使用率 （0-1 区间范围）
- W = 等待时间
- C = 计算时间
- W/C = 等待时间和计算时间的比例
- 理想线程数 = N * U * (1 + W/C)

第二种：

- 如果是计算密集型的应用，则设置 `N + 1` 线程数，其中 `N` 表示 CPU 数量
- 如果是 IO 密集型的应用，则设置 `2N` 线程数，其中 `N` 表示 CPU 数量

### CPU 密集型运算

通常采用 `CPU 核数 + 1` 能够实现最优的 CPU 利用率，`+1` 是保证当线程由于页缺失故障（操作系统）或其它原因
导致暂停时，额外的这个线程就能顶上去，保证 CPU 时钟周期不被浪费

### I/O 密集型运算

CPU 不总是处于繁忙状态，例如，当你执行业务计算时，这时候会使用 CPU 资源，
但当你执行 I/O 操作时、远程 RPC 调用时，包括进行数据库操作时，这时候 CPU 就闲下来了，你可以利用多线程提高它的利用率。

经验公式如下

```text
线程数 = 核数 * 期望 CPU 利用率 * 总时间(CPU 计算时间 + 等待时间) / CPU 计算时间
```

例如 4 核 CPU 计算时间是 50%，其它等待时间是 50%，期望 CPU 被 100% 利用，套用公式

```text
4 * 100% * 100% / 50% = 8
```

例如 4 核 CPU 计算时间是 10%，其它等待时间是 90%，期望 CPU 被 100% 利用，套用公式

```text
4 * 100% * 100% / 10% = 40
```

## 阻塞队列大小
