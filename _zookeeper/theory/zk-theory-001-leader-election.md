---
title: "Leader 选举"
sequence: "101"
---

## 选举机制

- 半数机制：集群中半数以上机器存活，集群可用。所以，ZooKeeper 适合安装奇数台服务器。
- 在配置文件中，ZooKeeper 并没有指定 Master 和 Slave。但是，ZooKeeper 工作时，是有一个节点为 Leader，其它为 Follower。
  Leader 是通过内部的选举机制产生的。

## 集群首次启动

假设有 5 台服务器组成的 ZooKeeper 集群，它们的 id 从 1-5；同时，它们都是最新启动的，没有历史数据，都没有存放数据。
如果这些服务器依次启动，会发生什么呢？

- 服务器 1 启动。此时，只有它一台服务器启动了，它发出去的报文，没有接收到任何响应，所以它的选举状态是 LOOKING 状态。
- 服务器 2 启动。它与最开始启动的服务器 1 进行通信，互相交换自己的选举结果。由于两者都没有历史数据，所以 id 值较大的服务器 2 胜出。
  但是，由于没有达到超过半数以上的服务器都同意选举它（这个例子中的半数以上是3），所以服务器 1、2 还是继续保持 LOOKING 状态。
- 服务器 3 启动，根据前面的理论分析，服务器 3 成为服务器 1、2、3 中的老大，而与上面不同的是，此时有三台服务器选举了它，
  所以它成为了这次选举的 Leader。
- 服务器 4 启动。根据前面的理论分析，理论上服务器 4 应该是服务器 1、2、3、4中最大的，但是由于前面已经有半数以上的服务器选举了服务器 3，
  所以它只能接受当小北的命了。
- 服务器 5 启动。同服务器 4 一样成为 Follower。

### 集群非首次启动

每个节点在选举时，都会参考自身节点的 `ZXID` 值（事务 ID）；优先选择 `ZXID` 值大的节点成为 Leader。

