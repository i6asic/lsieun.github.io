---
title: "ZAB 一致性协议"
sequence: "102"
---

## 分布式数据一致性问题

为什么会出现分布式一致性问题？

- 将数据复制到分布式部署的多台机器中，可以消除单点故障，防止系统由于某台（些）机器宕机导致的不可用。
- 通过负载均衡技术，能够让分布在不同地方的数据副本全部对外提供服务，有效提高系统性能。

在分布式系统中，引入数据复制机制后，多台数据节点之间由于网络等原因，很容易产生数据不一致的情况。

举例：当客户端 Client1 将系统中的一个值 `K1` 由 `V1` 更新为 `V2`，但是客户端 Client2 读取是一个还没有同步的副本，
`K1` 的值依然是 `V1`，这就导致了数据的不一致性。其中，最常见的就是主从数据库之间的复制延迟问题。

## ZAB 协议

ZK 就是分布式一致性问题的工业解决方案，Paxos 是其底层理论算法。
其中，ZAB、RAFT 和 众多开源算法就是对 Paxos 的工业级实现。
ZK 没有完全采用 Paxos 算法，
而是使用了一种 ZooKeeper Atomic Broadcast（ZAB，ZooKeeper 原子消息广播协议）的协议作为其数据一致性的核心算法。

> Paxos is a three-phase algorithm that allows multiple nodes to agree on a value
> in spite of partial network or node failures.

**ZAB 协议，是为分布式协调服务 ZooKeeper 专门设计的一种支持崩溃恢复和原子广播协议。**

### 主备模式保证一致性

ZK 怎么处理集群中的数据？所有客户端写入数据都是写入 Leader，然后，由于 Leader 复制到 Follower 中。
ZAB 会将服务器数据的状态变更以事务 Proposal 的形式广播到所有的副本进程上，
ZAB 协议能够保证了事务操作的一个全局的变更序列号（`ZXID`）。

### 广播消息

ZAB 协议的消息广播类似于 **二阶段提交过程**。
对于客户端发送的**写请求**，全部由 Leader 接收，
Leader 将请求封装成一个事务 Proposal（提议），将其发送给所有 Follower。
如果收到超过半数反馈 ACK，则执行 Commit 操作（先提交自己，再发送 Commit 给所有 Follower）。
不能正常反馈的 Follower，恢复正常后，会进入数据同步阶段，最终与 Leader 保持一致。

细节：

- Leader 接收到 Client 请求之后，会将这个请求封装成一个事务，并给这个事务分配一个全局递增的唯一 ID，称为事务 ID（`ZXID`），
  ZAB 协议要求保证事务的顺序，因此必须将每一个事务按照 `ZXID` 进行先后排序然后处理。
- ZK 集群为了保证任何事务操作能够有序的顺序执行，只能是 Leader 服务器接受写请求，即使是 Follower 服务器接收到客户端的请求，
  也会转发到 Leader 服务器进行处理。

ZK 提供的应该是**最终一致性**的标准：ZK 所有节点接收**写请求**之后，可以在一定时间内保证所有节点都能看到该条数据。

## Leader 崩溃问题

Leader 宕机后，ZK 集群无法正常工作，ZAB 协议提供了一个高效且可靠的 Leader 选举算法。

旧 Leader 宕机后，被选举的新 Leader 需要解决的问题：

- ZAB 协议确保那些已经在 Leader 提交的事务，最终会被所有服务器提交。
- ZAB 协议确保丢弃那些只在 Leader 提出/复制，但没有提交的事务。

基于上面的目的，ZAB 协议设计了一个选举算法：能够确保已经被 Leader 提交的事务被集群接受，丢弃还没有提交的事务。

这个选举算法的关键点：保证选举出的新 Leader 拥有集群中所有节点最大编号（`ZXID`）的事务。

