---
title: "哨兵模式"
sequence: "103"
---

## 哨兵模式介绍

![](/assets/images/redis/ha/redis-sentinel.png)

Redis 提供了哨兵的命令，是一个独立的进程。

原理：哨兵通过发送命令给多个节点，等待 Redis 服务器响应，从而监控运行的多个 Redis 实例的运行情况。

当哨兵监测到 master 宕机，会自动将 slave 切换成 master，然后通知其它的 Slave 服务器，修改配置文件切换指向 Master 的 IP 地址。

## Sentinel 职能

- 监控（Monitoring）
- 提醒（Notification）
- 自动故障迁移（Automatic failover）

- **Monitoring**: This is basically when sentinel checks if the master and slave instances are working as expected.
- **Notification**: This is when the sentinel notifies other programs or other system administrators via an API
  when there is something wrong with the monitoring instances.
- **Automatic Failover**: On a master failure, the sentinel promotes one of the slaves to become the new master and
  then makes the other additional slaves use the new master.

### 监控

Sentinel 会不断地检查 Master 服务器和 Slave 服务器是否运作正常。

### 提醒

当被监控的某个 Redis 服务器出现问题时，Sentinel 可以通过 API 向管理员或者其它应用程序发送通知

### 自动故障迁移

当一个主服务器不能正常工作时，Sentinel 会开始一次自动故障迁移操作，
当 Master 服务器发生故障时，其中一个 Slave 服务器升级为新的 Master 服务器，
并让其它 Slave 服务器改为复制新的 Master 服务器。

当客户端试图连接失效的 Master 服务器时，集群也会向客户端返回新 Master 服务器的地址，使得集群可以使用新 Master 服务器代替失效服务器。

## 实践

- Master: `192.168.80.131`
- Slave1: `192.168.80.132`
- Salve2: `192.168.80.133`
- Sentinel1: `192.168.80.231`
- Sentinel2: `192.168.80.232`
- Sentinel3: `192.168.80.233`

```text
sudo yum -y install gcc-c++ autoconf automake wget
wget https://download.redis.io/redis-stable.tar.gz
tar -zxvf redis-stable.tar.gz
cd redis-stable
make
sudo firewall-cmd --zone=public --add-port=26379/tcp --permanent
sudo firewall-cmd --reload
echo "Redis Installed Success"
```

注意：默认 Sentinel 默认开启 `26379` 端口

### Sentinel1

File: `sentinel-1.conf`

```text
daemonize yes
bind 0.0.0.0
port 26379

dir "./"
logfile "./sentinel-1.log"

sentinel down-after-milliseconds mymaster 5000
sentinel monitor mymaster 192.168.80.131 6379 2
sentinel auth-pass mymaster str0ng_passw0rd
sentinel failover-timeout mymaster 30000
```

- `sentinel monitor` 说明当有 2 个 Sentinel 节点无法访问 `192.168.80.130:6379` 时，就客观判定该 Master 不可用，将 master 做下线处理,并进行故障转移(failover) ,额外补充下 mymaster 是 Sentinel 分组名称,同一组 sentinel 必须设置相同的名字 mymaster
- `sentinel down-after-milliseconds` 说明当 ping 超过 5000 毫秒没响应,则主观判定为下线
- `sentinel failover-timeout`：说明当超过 30 秒还没有完成故障转移,则认为故障转移失败.
- `sentinel auth-pass` 连接到 master auth 时设置的密码

```text
./src/redis-server ./sentinel-1.conf --sentinel
tail -f sentinel-1.log
```

```text
* Running mode=sentinel, port=26379.
* Sentinel new configuration saved on disk
* Sentinel ID is b4b0a0d441d490446bca4836d7400be58194a4c0
# +monitor master mymaster 192.168.80.131 6379 quorum 2
* +slave slave 192.168.80.132:6379 192.168.80.132 6379 @ mymaster 192.168.80.131 6379
* Sentinel new configuration saved on disk
* +slave slave 192.168.80.133:6379 192.168.80.133 6379 @ mymaster 192.168.80.131 6379
* Sentinel new configuration saved on disk
```

```text
$ cat sentinel-1.conf 
bind 0.0.0.0
port 26379
daemonize yes
dir "/home/devops/redis-stable"
logfile "./sentinel-1.log"
sentinel monitor mymaster 192.168.80.131 6379 2
sentinel down-after-milliseconds mymaster 5000
sentinel auth-pass mymaster str0ng_passw0rd
sentinel failover-timeout mymaster 30000

# Generated by CONFIG REWRITE                    # 注意下面的信息是 Sentinel 自动生成的
latency-tracking-info-percentiles 50 99 99.9
maxclients 4064
pidfile "/var/run/redis.pid"
protected-mode no
user default on nopass sanitize-payload ~* &* +@all
sentinel myid b4b0a0d441d490446bca4836d7400be58194a4c0
sentinel config-epoch mymaster 0
sentinel leader-epoch mymaster 0
sentinel current-epoch 0

sentinel known-replica mymaster 192.168.80.132 6379

sentinel known-replica mymaster 192.168.80.133 6379
```

### Sentinel2

File: `sentinel-2.conf`

```text
daemonize yes
bind 0.0.0.0
port 26379

dir "./"
logfile "./sentinel-2.log"

sentinel monitor mymaster 192.168.80.131 6379 2
sentinel down-after-milliseconds mymaster 5000
sentinel auth-pass mymaster str0ng_passw0rd
sentinel failover-timeout mymaster 30000
```

```text
./src/redis-server ./sentinel-2.conf --sentinel
tail -f sentinel-2.log
```

```text
* Running mode=sentinel, port=26379.
* Sentinel new configuration saved on disk
* Sentinel ID is 807a49f83abc7f3ab722b795d73e29ad7b9f7924
# +monitor master mymaster 192.168.80.131 6379 quorum 2
* +slave slave 192.168.80.132:6379 192.168.80.132 6379 @ mymaster 192.168.80.131 6379
* Sentinel new configuration saved on disk
* +slave slave 192.168.80.133:6379 192.168.80.133 6379 @ mymaster 192.168.80.131 6379
* Sentinel new configuration saved on disk
* +sentinel sentinel b4b0a0d441d490446bca4836d7400be58194a4c0 192.168.80.231 26379 @ mymaster 192.168.80.131 6379
* Sentinel new configuration saved on disk
```

### Sentinel3

File: `sentinel-3.conf`

```text
daemonize yes
bind 0.0.0.0
port 26379

dir "./"
logfile "./sentinel-3.log"

sentinel monitor mymaster 192.168.80.131 6379 2
sentinel down-after-milliseconds mymaster 5000
sentinel auth-pass mymaster str0ng_passw0rd
sentinel failover-timeout mymaster 30000
```

```text
./src/redis-server ./sentinel-3.conf --sentinel
tail -f sentinel-3.log
```

### 测试

连接 `192.168.80.231` 的 `26379` 端口，输入 `INFO` 命令 或 `INFO SENTINEL` 命令：

```text
> INFO SENTINEL
# Sentinel
sentinel_masters:1
sentinel_tilt:0
sentinel_tilt_since_seconds:-1
sentinel_running_scripts:0
sentinel_scripts_queue_length:0
sentinel_simulate_failure_flags:0
master0:name=mymaster,status=ok,address=192.168.80.131:6379,slaves=2,sentinels=3
```

### 测试 Master 出现故障

第 1 步，`tail -f sentinel-x.log` 查看三个 Sentinel 的日志

第 2 步，结束 `192.168.80.131`（Master）的  Redis 进程：

```text
$ kill -9 <PID>
```

第 3 步，查看 Sentinel 的日志：

```text
# +sdown master mymaster 192.168.80.131 6379                                             # Master 关闭
* Sentinel new configuration saved on disk
# +new-epoch 1
* Sentinel new configuration saved on disk
# +vote-for-leader 807a49f83abc7f3ab722b795d73e29ad7b9f7924 1                            # 选举 Leader
# +odown master mymaster 192.168.80.131 6379 #quorum 3/2
* Next failover delay: I will not start a failover before Mon Dec 11 11:01:24 2023
# +config-update-from sentinel 807a49f83abc7f3ab722b795d73e29ad7b9f7924 192.168.80.232 26379 @ mymaster 192.168.80.131 6379
# +switch-master mymaster 192.168.80.131 6379 192.168.80.132 6379                        # 切换 Master 服务
* +slave slave 192.168.80.133:6379 192.168.80.133 6379 @ mymaster 192.168.80.132 6379    # 修改 Slave 指向 Master 的 IP
* +slave slave 192.168.80.131:6379 192.168.80.131 6379 @ mymaster 192.168.80.132 6379
* Sentinel new configuration saved on disk
# +sdown slave 192.168.80.131:6379 192.168.80.131 6379 @ mymaster 192.168.80.132 6379
```

```text
# +sdown master mymaster 192.168.80.131 6379
# +odown master mymaster 192.168.80.131 6379 #quorum 2/2
# +new-epoch 1
# +try-failover master mymaster 192.168.80.131 6379
* Sentinel new configuration saved on disk
# +vote-for-leader 807a49f83abc7f3ab722b795d73e29ad7b9f7924 1
* 54595711acb0230d9aca7da3745f4d73c3393d7e voted for 807a49f83abc7f3ab722b795d73e29ad7b9f7924 1
* b4b0a0d441d490446bca4836d7400be58194a4c0 voted for 807a49f83abc7f3ab722b795d73e29ad7b9f7924 1
# +elected-leader master mymaster 192.168.80.131 6379
# +failover-state-select-slave master mymaster 192.168.80.131 6379
# +selected-slave slave 192.168.80.132:6379 192.168.80.132 6379 @ mymaster 192.168.80.131 6379
* +failover-state-send-slaveof-noone slave 192.168.80.132:6379 192.168.80.132 6379 @ mymaster 192.168.80.131 6379
* +failover-state-wait-promotion slave 192.168.80.132:6379 192.168.80.132 6379 @ mymaster 192.168.80.131 6379
* Sentinel new configuration saved on disk
# +promoted-slave slave 192.168.80.132:6379 192.168.80.132 6379 @ mymaster 192.168.80.131 6379
# +failover-state-reconf-slaves master mymaster 192.168.80.131 6379
* +slave-reconf-sent slave 192.168.80.133:6379 192.168.80.133 6379 @ mymaster 192.168.80.131 6379
* +slave-reconf-inprog slave 192.168.80.133:6379 192.168.80.133 6379 @ mymaster 192.168.80.131 6379
* +slave-reconf-done slave 192.168.80.133:6379 192.168.80.133 6379 @ mymaster 192.168.80.131 6379
# -odown master mymaster 192.168.80.131 6379
# +failover-end master mymaster 192.168.80.131 6379
# +switch-master mymaster 192.168.80.131 6379 192.168.80.132 6379
* +slave slave 192.168.80.133:6379 192.168.80.133 6379 @ mymaster 192.168.80.132 6379
* +slave slave 192.168.80.131:6379 192.168.80.131 6379 @ mymaster 192.168.80.132 6379
* Sentinel new configuration saved on disk
# +sdown slave 192.168.80.131:6379 192.168.80.131 6379 @ mymaster 192.168.80.132 6379
# -sdown slave 192.168.80.131:6379 192.168.80.131 6379 @ mymaster 192.168.80.132 6379
```

哨兵和客户端通信事件的一些重要频道： 
- （1）`+sdown`（实例进入主观下线状态） 
- （2）`-sdown`（实例退出主观下线状态）
- （3）`+odown`（实例进入客观下线状态）
- （4）`-odown`（实例退出客观下线状态）
- （5）`+swtich-master`（主库地址发生变化）
- （6）`+slave-reconf-sent`（哨兵发送 `SLAVEOF` 命令重新配置从库）
- （7）`+slave-reconf-inprog`（从库配置了新主库，但尚未同步）
- （8）`+slave-reconf-done`（从库配置了新主库，和新主库完成同步） 

第 4 步，观察 Slave2 （`192.168.80.133`）上 `redis-slave2.conf` 的内容变化：

```text
# 注意：原来是 131，现在是 132
replicaof 192.168.80.132 6379
```

第 5 步，重启 192.168.80.131 上的 Redis，再次查看 `redis-master.conf` 文件，新增如下内容：

```text
replicaof 192.168.80.132 6379
```
