---
title: "主从同步原理"
sequence: "102"
---

## 主从同步原理

主从复制分两种：

- 主从刚连接的时候，进行全量同步；
- 全同步结束后，进行增量同步

### 全量复制

- 第 1 步，Master 服务器会开启一个后台进程，将 Redis 中的数据生成一个 rdb 文件
- 第 2 步，Master 服务器会缓存所有接收到的来自客户端的写命令，当后台保存进程处理完毕后，会将该 rdb 文件传递给 Slave 服务器
- 第 3 步，Slave 服务器会将 rdb 文件保存在磁盘，并通过读取该文件将数据加载到内存
- 第 4 步，在此之后 master 服务器会将在此期间缓存的命令通过 Redis 传输协议发送给 Slave 服务器
- 第 5 步，然后 Slave 服务器将这些命令依次作用于自己本地的数据集上最终达到数据的一致性

![](/assets/images/redis/ha/master-slave-sync-data-full.png)

### 增量复制

- 第 1 步，Slave 初始化后开始正常工作时主服务器发生的写操作同步到从服务器的过程
- 第 2 步，服务器每执行一个写命令就会向从服务器发送相同的写命令，从服务器接收并执行收到的写命令

![](/assets/images/redis/ha/master-slave-sync-data-increment.png)

### 全量/增量特点

- 在主从复制过程中，Master 和 Slave 服务器是非阻塞（Non-Blocking）的，所以同步期间都可以正常处理外界请求
- 一个 Master 可以含有多个 Slave；当 Master 出现故障后，其中一个 Slave 可以变成 Master，从而接收来其它 Slave 服务器的连接
- Slave 不会让 Key 过期，而是 Master 的 Key 过期删除后，成为 `DEL` 命令传输到 Slave 进行删除

### 加速复制

在进行全量同步时，Master 服务器需要在磁盘上创建一个 RDB 文件，然后加载这个文件以便为 Slave 服务器发送数据。
在比较低速的磁盘，这种操作会给 Master 服务器带来较大的压力；
新版支持无磁盘的复制，子进程直接将 RDB 通过网络发送给从服务器，不使用磁盘作为中间存储：

```text
repl-diskless-sync no
```

注意：使用无盘复制会降低可靠性

### 主从断开重连

如果遭遇连接断开，重新连接之后可以从中断处继续进行复制，而不必重新同步。

2.8 版本后部分重新同步这个新特性内部使用 `PSYNC` 命令，旧的实现中使用 `SYNC` 命令
