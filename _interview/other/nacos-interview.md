---
title: "Nacos"
sequence: "nacos"
---

## 使用

### 注册到 nacos 的服务的数据结构

```text
namespace > group > service > cluster > instance
```

### Nacos 服务是如何判定服务实例的状态？

通过发送心跳包，5 秒发送一次，如果 15 秒没有回应，则说明服务出现了问题，
如果 30 秒后没有回应，则说明服务已经停止。## Nacos 服务是如何判定服务实例的状态？

通过发送心跳包，5 秒发送一次，如果 15 秒没有回应，则说明服务出现了问题，
如果 30 秒后没有回应，则说明服务已经停止。

## Nacos 中的保护阈值的作用是什么？

假如现在有一个服务，本来有 10 个实例，但是现在挂掉了 8 个，剩下 2 个正常实例，此时本来由 10 个实例处理的流量，就全部交给这个两个正常实例来处理了，
此时这两个实例很有可能是处理不过来的，最终导致被压垮。

为了应对这种情况，Nacos 提供了保护阈值这个功能，我们可以给某个服务设置一个 0-1 的阈值，比如 0.5，那就表示，一旦实例中只剩下一半的健康实例了，
比如 10 个实例，只剩下 5 个健康实例了，那么消费者在进行服务发现时，则会把该服务的所有实例，也包括不健康的实例都拉取到本地，
然后再从所有实例中进行负载均衡，选出一个实例进行调用，在这种情况下，选出来的即可能是一个健康的实例，也可能是挂掉的实例，但
是通过这种方式，很好的保护的剩下的健康实例，至少保证了一部分请求能正常的访问，而不至于所有请求都不能正常访问，这就是 Nacos 中的保护阈值
，同时，这个功能在 Spring Cloud Tencent 中叫全死全活。

## Nacos 中的负载均衡是怎么样的？

Nacos 的负载均衡指的是，在进行服务发现时进行负载均衡，正常情况下，在进行服务发现时，会根据服务名从 Nacos 中拉取所有的实例信息，
但是 Nacos 中提供了一个功能，就是可以在拉取实例时，可以根据随机策略只拉取到所有实例中的某一个，这就是 Nacos 中的负载均衡，
它跟 Ribbon 的负载均衡并不冲突，可以理解为 Ribbon 的负载均衡是发生在 Nacos 的负载均衡之后的。

## Nacos 的就近访问是什么意思？

首先，在 Nacos 中，一个服务可以有多个实例，并且可以给实例设置 cluster-name，就是可以再进一步的给所有实例划分集群，
那如果现在某个服务 A 想要调用服务 B，那么 Naocs 会看调用服务 A 的实例是属于哪个集群的，并且调用服务 B 时，那就会调用同样集群下的服务 B 实例，
根据 cluster-name 来判断两个实例是不是同一个集群，这就是 Nacos 的就近访问。

## 你是怎么理解 CAP 理论的？

CAP 理论是分布式领域中最为重要的理论。
CAP 理论可以理解为目前硬件条件下对于分布式架构的一种限制，就是对于一个分布式系统，只能保证 AP 或 CP，而不能同时保证 CAP。
首先对于一个分布式系统，P，也就是分区容错性是一定要保证的，对于一个分布式系统，得保证在网络出现分区后，分布式系统仍然能工作，所以得保证 P，
只不过当出现网络分区后，整个分布式系统如果想要保证数据一致性，那么就要损耗系统可用性，或者如果想要保证系统的可用性，就不能保证系统的一致性，
这里说的是强一致性，因为如果网络出现问题，分布式系统中的数据就无法进行及时的同步，如果要求强一致性，那么就只能等网络好了之后，数据同步好了之后，
才能提供给用户使用，同理，如果要求网络出现后问题，系统要能使用，那就可能数据会不一致，所以对于一个分布式系统，目前来说只能保证 CP 或 AP。

## Nacos 中保证的是 CP 还是 AP？

通常我们说，Nacos 既能保证 CP，也能保证 AP，具体看如何配置，但其实只不过是 Nacos 中的注册中心能保证 CP 或 AP，Nacos 中的配置中心其实没什么 CP 或 AP，
因为配置中心的数据是存在一个 Mysql 中的，只有注册中心的数据需要进行集群节点之间的同步，从而涉及到是 CP 还是 AP，如果注册的节点是临时节点，那么就是 AP，如果是非临时节点，那么就是 CP，默认是临时节点。

如何理解 Nacos 中的命名空间？
命名空间，也就是 namespace，其实这个概念并不是 Nacos 中独有的，在 Nacos 中，不管是配置还是服务，都是属于某一个命名空间中的，默认情况下都是属于 pulibc 这个命名空间中的，我们可以在 Nacos 中新增命名空间，也就相当于开辟了另外一套存放服务和配置的地方，命名空间之间是独立的，完全不冲突的，所以我们可以利用 Nacos 中的命名空间来实现不同环境、不同租户之间的服务注册和配置。

你觉得注册中心应该是 CP 还是 AP？
我觉得大部分情况下，注册中心应该是 AP，如果注册中心是 CP 的，那么表示，当我们向注册中心注册实例或移除实例时，
都要等待注册中心集群中的数据达到一致后，才算注册或移除成功，而这是比较耗时的，
随着业务应用规模的增大，应用频繁的上下线，那么就会导致注册中心的压力比较大，会影响到服务发现的效率以及服务调用了，
而如果注册中心是 AP 的，那么注册中心集群不管出现了什么情况，都是可以提供服务的，就算集群节点之间数据出现了不一致，
对于业务应用而言，可能拉取到了一个已经下线了的服务节点，但是现在一般的微服务框架或组件都提供了服务容错和重试功能，
也可以避免这个问题，而如果是 AP，对于注册中心而言就不需要消耗太多的资源来实时的保证数据一致性了，保证最终一致性就可以了，
这样注册中心的压力会小一点，另外像 Zookeeper 来作为注册中心，因为 Zookeeper 保证的就是 CP，但是如果集群中如果大多数节点挂掉了，
就算还剩下一些 Zookeeper 节点，这些节点也是不能提供服务的，所以这个也不太合适，
所以综合来看，注册中心应该保证 AP 会更好，就像 Euraka、Nacos 他们默认保证的就是 AP。


