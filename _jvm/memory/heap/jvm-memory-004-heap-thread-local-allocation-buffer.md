---
title: "堆：线程 TLAB"
sequence: "104"
---

## 什么是 TLAB

**TLAB** 是 **Thread Local Allocation Buffer** 的缩写。

### TLAB 之前，存在什么问题

在使用 TLAB 之前，存在什么问题？

- 堆区，是线程共享区域，任何线程都可以访问到堆区中的共享数据；（区域共享）
- 由于对象实例的创建在 JVM 中非常频繁，因此，在并发环境下从堆区中划分内存空间是线程不安全的；（线程不安全）
- 为了避免多个线程操作同一个地址，需要使用加锁等机制，进而影响分配速度。（影响速度）

### TLAB 如何解决这个问题

从内存模型而不是垃圾回收的角度，对 Eden 区域继续进行划分，**JVM 为每一个线程分配了一个私有的缓存区域**，它包含在 Eden 空间内。

多线程同时分配内存时，使用 TLAB 可以避免一系列的非线程安全问题；
同时，还能够提升内存分配的吞吐量，
因此，我们可以将这种内存分配方式称之为**快速分配策略**。

## 细节

### 是否开启

在程序中，开发人员可以通过选项 `-XX:UseTLAB` 设置是否开启 TLAB 空间。

```text
jinfo -flag UseTLAB <pid>
```

### 存储位置

JVM 为每一个线程分配了一个私有的缓存区域，它包含在 **Eden 空间**内。

### 空间大小

在默认情况下，TLAB 空间的内存非常小，**仅占整个 Eden 空间的 1%**；

当然我们可以通过选项 `-XX:TLABWasteTargetPercent` 设置 TLAB 空间所占的 Eden 空间的百分比大小。

### 分配失败

尽管不是所有的对象实例都能够在 TLAB 中成功分配内存，但**JVM 确实是将 TLAB 作为内存分配的首选**。

一旦对象在 TLAB 空间分配内存失败时，JVM 就会尝试着通过**使用加锁机制**确保数据操作的原子性，从而直接在 Eden 空间中分配内存。

### 支持程度

所有 OpenJDK 衍生出来的 JVM 都提供了 TLAB 的设计。
