---
title: "Deflate Algorithm"
---

```text
           ┌─── block 1
           │
           │               ┌─── LZ77 algorithm
           ├─── block 2 ───┤
           │               └─── Huffman coding
           │
           ├─── block 3
           │
deflate ───┤                                                    ┌─── literals + lengths
           │               ┌─── a pair of Huffman code trees ───┤
           │               │                                    └─── distances
           ├─── block m ───┤
           │               │                                    ┌─── literal bytes
           │               └─── a compressed data ──────────────┤
           │                                                    └─── pointers: <length, backward distance>
           │
           └─── block n
```

DEFLATE Compressed Data Format is a lossless compressed data format
that compresses data using a combination of the LZ77 algorithm and Huffman coding.

**A compressed data set** consists of **a series of blocks**, corresponding to successive blocks of input data.

The **block sizes** are arbitrary, except that non-compressible blocks are limited to `65,535` bytes.

**Each block is compressed using a combination of the LZ77 algorithm and Huffman coding.**
**The Huffman trees** for each block are independent of those for previous or subsequent blocks;
**the LZ77 algorithm** may use a reference to a duplicated string occurring in a previous block, up to `32K` input bytes before.

**Each block consists of two parts**:
**a pair of Huffman code trees** that describe the representation of the compressed data part,
and **a compressed data** part.
(The Huffman trees themselves are compressed using Huffman encoding.)
The **compressed data** consists of a series of elements of two types:
**literal bytes** (of strings that have not been detected as duplicated within the previous 32K input bytes),
and **pointers to duplicated strings**, where a pointer is represented as a pair `<length, backward distance>`.
The representation used in the "deflate" format limits `distances` to `32K` bytes and `lengths` to `258` bytes,
but does not limit the size of a block, except for uncompressible blocks, which are limited as noted above.

Each type of value (`literals`, `distances`, and `lengths`) in the compressed data is represented using a Huffman code,
using **one code tree** for `literals` and `lengths` and **a separate code tree** for `distances`.
**The code trees** for each block appear in a compact form just before **the compressed data** for that block.

## Compressed block format

- codes (bit sequence): symbol
- alphabet --> symbol frequencies --> binary tree --> prefix code --> bit lengths

### Details of block format

Each block of compressed data begins with **3 header bits** containing the following data:

```text
first bit       BFINAL
next 2 bits     BTYPE
```

Note that the **header bits** do not necessarily begin on a byte boundary,
since a block does not necessarily occupy an integral number of bytes.

`BFINAL` is set if and only if this is the last block of the data set.

`BTYPE` specifies how the data are compressed, as follows:

- `00` - no compression
- `01` - compressed with fixed Huffman codes
- `10` - compressed with dynamic Huffman codes
- `11` - reserved (error)

The only difference between the two compressed cases is
how the Huffman codes for the `literal`/`length` and `distance` alphabets are defined.

### Non-compressed blocks (BTYPE=00)

Any bits of input up to the next byte boundary are ignored.
The rest of the block consists of the following information:

```text
  0   1   2   3   4...
+---+---+---+---+================================+
|  LEN  | NLEN  |... LEN bytes of literal data...|
+---+---+---+---+================================+
```

- `LEN` is the number of data bytes in the block.
- `NLEN` is the one's complement of `LEN`.

### Compressed blocks (length and distance codes)

Encoded data blocks in the "deflate" format consist of sequences of symbols
drawn from **three conceptually distinct alphabets**:
- either **literal bytes**, from the alphabet of byte values `(0..255)`, or
- `<length, backward distance>` pairs, where the `length` is drawn from `(3..258)` and
- the `distance` is drawn from `(1..32,768)`.

In fact, the `literal` and `length` alphabets are merged into a single alphabet `(0..285)`,
where values `0..255` represent literal bytes,
the value `256` indicates end-of-block,
and values `257..285` represent length codes
(possibly in conjunction with extra bits following the symbol code) as follows:

```text
     Extra               Extra               Extra
Code Bits Length(s) Code Bits Lengths   Code Bits Length(s)
---- ---- ------     ---- ---- -------   ---- ---- -------
 257   0     3       267   1   15,16     277   4   67-82
 258   0     4       268   1   17,18     278   4   83-98
 259   0     5       269   2   19-22     279   4   99-114
 260   0     6       270   2   23-26     280   4  115-130
 261   0     7       271   2   27-30     281   5  131-162
 262   0     8       272   2   31-34     282   5  163-194
 263   0     9       273   3   35-42     283   5  195-226
 264   0    10       274   3   43-50     284   5  227-257
 265   1  11,12      275   3   51-58     285   0    258
 266   1  13,14      276   3   59-66
```

The extra bits should be interpreted as a machine integer stored with
the most-significant bit first, e.g., bits `1110` represent the value `14`.

```text
     Extra           Extra               Extra
Code Bits Dist  Code Bits   Dist     Code Bits Distance
---- ---- ----  ---- ----  ------    ---- ---- --------
  0   0    1     10   4     33-48    20    9   1025-1536
  1   0    2     11   4     49-64    21    9   1537-2048
  2   0    3     12   5     65-96    22   10   2049-3072
  3   0    4     13   5     97-128   23   10   3073-4096
  4   1   5,6    14   6    129-192   24   11   4097-6144
  5   1   7,8    15   6    193-256   25   11   6145-8192
  6   2   9-12   16   7    257-384   26   12  8193-12288
  7   2  13-16   17   7    385-512   27   12 12289-16384
  8   3  17-24   18   8    513-768   28   13 16385-24576
  9   3  25-32   19   8   769-1024   29   13 24577-32768
```

### Compression with fixed Huffman codes (BTYPE=01)

The Huffman codes for the two alphabets are fixed, and are not represented explicitly in the data.
The Huffman code lengths for the `literal`/`length` alphabet are:

```text
Lit Value    Bits        Codes
---------    ----        -----
  0 - 143     8          00110000 through 10111111
144 - 255     9          110010000 through 111111111
256 - 279     7          0000000 through 0010111
280 - 287     8          11000000 through 11000111
```

```text
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ■
                                                                                                                                                                                                                                                                                                                                                                                                           0 ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐ 1
                                                                                                                                                                                                                                                                                                                                                                                                             ■                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ■
                                                                                                                                                           0 ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐ 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0 ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐ 1
                                                                                                                                                             ■                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ■                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ■                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ■
                                                                           0 ┌───────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────┐ 1                                                                                                                                                                                                                                                                                                                           0 ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐ 1                                                                                                                                                                                                                                                                                                                           0 ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐ 1                                                                                                                                                                                                                                                                                                                                                                                                           0 ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐ 1
                                                                             ■                                                                                                                                                               ■                                                                                                                                                                                                                                                                                                                               ■                                                                                                                                                                                                                                                                                                                               ■                                                                                                                                                                                                                                                                                                                               ■                                                                                                                                                                                                                                                                                                                               ■                                                                                                                                                                                                                                                                                                                                                                                                               ■                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ■
                                   0 ┌───────────────────────────────────────┴───────────────────────────────────────┐ 1                                                                           0 ┌───────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────┐ 1                                                                                                                                                           0 ┌───────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────┐ 1                                                                                                                                                           0 ┌───────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────┐ 1                                                                                                                                                           0 ┌───────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────┐ 1                                                                                                                                                           0 ┌───────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────┐ 1                                                                                                                                                           0 ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐ 1                                                                                                                                                                                                                                                                                                                           0 ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐ 1
                                     ■                                                                               ■                                                                               ■                                                                                                                       ■                                                                                                                                                               ■                                                                                                                                                               ■                                                                                                                                                               ■                                                                                                                                                               ■                                                                                                                                                               ■                                                                                                                                                               ■                                                                                                                                                               ■                                                                                                                                                               ■                                                                                                                                                               ■                                                                                                                                                                                                                                                                                                                               ■                                                                                                                                                                                                                                                                                                                               ■                                                                                                                                                                                                                                                                                                                               ■
               0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                                       0 ┌───────────────────────────────────────┴───────────────────────────────────────┐ 1                                                                           0 ┌───────────────────────────────────────┴───────────────────────────────────────┐ 1                                                                           0 ┌───────────────────────────────────────┴───────────────────────────────────────┐ 1                                                                           0 ┌───────────────────────────────────────┴───────────────────────────────────────┐ 1                                                                           0 ┌───────────────────────────────────────┴───────────────────────────────────────┐ 1                                                                           0 ┌───────────────────────────────────────┴───────────────────────────────────────┐ 1                                                                           0 ┌───────────────────────────────────────┴───────────────────────────────────────┐ 1                                                                           0 ┌───────────────────────────────────────┴───────────────────────────────────────┐ 1                                                                           0 ┌───────────────────────────────────────┴───────────────────────────────────────┐ 1                                                                           0 ┌───────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────┐ 1                                                                                                                                                           0 ┌───────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────┐ 1                                                                                                                                                           0 ┌───────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────┐ 1                                                                                                                                                           0 ┌───────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────┐ 1
                 ■                                       ■                                       ■                                       ■                                       ■                                       ■                                                           ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                                                                       ■                                                                                                                                                               ■                                                                                                                                                               ■                                                                                                                                                               ■                                                                                                                                                               ■                                                                                                                                                               ■                                                                                                                                                               ■
     0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1                         0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                                       0 ┌───────────────────────────────────────┴───────────────────────────────────────┐ 1                                                                           0 ┌───────────────────────────────────────┴───────────────────────────────────────┐ 1                                                                           0 ┌───────────────────────────────────────┴───────────────────────────────────────┐ 1                                                                           0 ┌───────────────────────────────────────┴───────────────────────────────────────┐ 1                                                                           0 ┌───────────────────────────────────────┴───────────────────────────────────────┐ 1                                                                           0 ┌───────────────────────────────────────┴───────────────────────────────────────┐ 1                                                                           0 ┌───────────────────────────────────────┴───────────────────────────────────────┐ 1
       ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                             ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                                           ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■                                                                               ■
0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1          0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1                         0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1                                   0 ┌───────────────────┴───────────────────┐ 1
  □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □              ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                             ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■                                       ■
  256       257       258       259       260       261       262       263       264       265       266       267       268       269       270       271       272       273       274       275       276       277       278       279     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1          0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1               0 ┌─────────┴─────────┐ 1
                                                                                                                                                                                                                                                  □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □              ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■                   ■
                                                                                                                                                                                                                                                  0         1         2         3         4         5         6         7         8         9         10        11        12        13        14        15        16        17        18        19        20        21        22        23        24        25        26        27        28        29        30        31        32        33        34        35        36        37        38        39        40        41        42        43        44        45        46        47        48        49        50        51        52        53        54        55        56        57        58        59        60        61        62        63        64        65        66        67        68        69        70        71        72        73        74        75        76        77        78        79        80        81        82        83        84        85        86        87        88        89        90        91        92        93        94        95        96        97        98        99        100       101       102       103       104       105       106       107       108       109       110       111       112       113       114       115       116       117       118       119       120       121       122       123       124       125       126       127       128       129       130       131       132       133       134       135       136       137       138       139       140       141       142       143       280       281       282       283       284       285       286       287     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1     0 ┌────┴────┐ 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □         □
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  144       145       146       147       148       149       150       151       152       153       154       155       156       157       158       159       160       161       162       163       164       165       166       167       168       169       170       171       172       173       174       175       176       177       178       179       180       181       182       183       184       185       186       187       188       189       190       191       192       193       194       195       196       197       198       199       200       201       202       203       204       205       206       207       208       209       210       211       212       213       214       215       216       217       218       219       220       221       222       223       224       225       226       227       228       229       230       231       232       233       234       235       236       237       238       239       240       241       242       243       244       245       246       247       248       249       250       251       252       253       254       255
```

The code lengths are sufficient to generate the actual codes, as described above;
we show the codes in the table for added clarity.
**Literal**/**length** values 286-287 will never actually occur in the compressed data,
but participate in the code construction.

Distance codes `0-31` are represented by (fixed-length) 5-bit codes,
with possible additional bits as shown in the table shown in Paragraph 3.2.5, above.
Note that distance codes `30-31` will never actually occur in the compressed data.

### Compression with dynamic Huffman codes (BTYPE=10)

**The Huffman codes for the two alphabets** appear in the block
immediately after **the header bits** and before **the actual compressed data**,
first the `literal`/`length` code and then the `distance` code.
Each code is defined by a sequence of code lengths, as discussed in Paragraph 3.2.2, above.
For even greater compactness, the **code length sequences** themselves are compressed using a Huffman code.
The alphabet for code lengths is as follows:

```text
0 - 15: Represent code lengths of 0 - 15
    16: Copy the previous code length 3 - 6 times.
        The next 2 bits indicate repeat length
              (0 = 3, ... , 3 = 6)
           Example:  Codes 8, 16 (+2 bits 11),
                     16 (+2 bits 10) will expand to
                     12 code lengths of 8 (1 + 6 + 5)
    17: Repeat a code length of 0 for 3 - 10 times. (3 bits of length)
    18: Repeat a code length of 0 for 11 - 138 times (7 bits of length)
```

A **code length** of `0` indicates that
the corresponding symbol in the `literal`/`length` or `distance` alphabet will not occur in the block,
and should not participate in the Huffman code construction algorithm given earlier.
If only one distance code is used, it is encoded using one bit, not zero bits;
in this case there is a single code length of one, with one unused code.
**One distance code of zero bits** means that **there are no distance codes used at all** (**the data is all literals**).

We can now define the format of the block:

```text
5 Bits: HLIT, # of Literal/Length codes - 257 (257 - 286)
5 Bits: HDIST, # of Distance codes - 1        (1 - 32)
4 Bits: HCLEN, # of Code Length codes - 4     (4 - 19)
(HCLEN + 4) x 3 bits: code lengths for the code length
   alphabet given just above, in the order: 16, 17, 18,
   0, 8, 7, 9, 6, 10, 5, 11, 4, 12, 3, 13, 2, 14, 1, 15

   These code lengths are interpreted as 3-bit integers
   (0-7); as above, a code length of 0 means the
   corresponding symbol (literal/length or distance code
   length) is not used.

HLIT + 257 code lengths for the literal/length alphabet,
   encoded using the code length Huffman code

HDIST + 1 code lengths for the distance alphabet,
   encoded using the code length Huffman code

The actual compressed data of the block,
   encoded using the literal/length and distance Huffman
   codes

The literal/length symbol 256 (end of data),
   encoded using the literal/length Huffman code
```

The code length repeat codes can cross from HLIT + 257 to the HDIST + 1 code lengths.
In other words, all code lengths form a single sequence of HLIT + HDIST + 258 values.

## Lempel–Ziv

The idea is to maintain a **hash table** with the positions of four-character prefixes
that have occurred previously in the string (shorter back references are not considered profitable).
For Deflate, only back references to the most recent `32,768` characters, the window, are allowed.
This enables **streaming compression**: the input can be processed a little at a time, as long as the window with the most recent bytes are kept in memory.

Changing parameters such as how far back the list of prefixes to search is a way of trading **less compression** for **more speed**.

Lempel–Ziv compression can be both fast and slow.

The Lempel–Ziv idea of using the source data itself as the dictionary is very elegant, but using a static dictionary can still be beneficial.

## Huffman Coding

The second ingredient in Zip compression is Huffman coding.

The term **code** in this context refers to a system for representing **some data** in **another form**.
For our purposes, we are interested in **codes** that can be used to represent the **literals** and **back references** produced by the Lempel–Ziv compression above efficiently.

This means we can look at **three bits of input** and compare against the **sentinel bits** to figure out **how long our codeword is**.

## Deflate

DEFLATE also limits the match length to a minimum of 3 and a maximum of 258.

### Bitstreams

Deflate stores **Huffman codewords** in a **least-significant-bit-first** (**LSB-first**) bitstream,
meaning that the first bit of the stream is stored in the least significant bit of the first byte.

For example, consider this bit stream (read left-to-right): 1-0-0-1-1.
When stored LSB-first in a byte, the byte's value becomes `0b00011001` (binary) or `0x19` (hexadecimal).
This might seem backwards (in a sense it is),
but one advantage is that it makes it easy to get the first N bits from a computer word: just mask off the N lowest bits.

### Decompression (Inflation)

Since the compression algorithm is called **Deflate**—to let the air out of something—the decompression process is sometimes referred to as **Inflation**.

Deflate-compressed data is stored as a series of **blocks**.
Each **block** starts with a 3-bit header
where the first (least significant) bit is set if this is the final block of the series,
and the other two bits indicate the block type.

## References

- [★★★ 1996-05 RFC1951: DEFLATE Compressed Data Format Specification version 1.3](https://datatracker.ietf.org/doc/html/rfc1951)
- [★★★ Zip Files: History, Explanation and Implementation](https://www.hanshq.net/zip.html)
- [An Explanation of the Deflate Algorithm](https://zlib.net/feldspar.html)
- [How Deflater works](https://www.javamex.com/tutorials/compression/deflater_algorithm.shtml)
- [Simple DEFLATE decompressor](https://www.nayuki.io/page/simple-deflate-decompressor)
- [Github: RidgeX/deflate-impl](https://github.com/RidgeX/deflate-impl)
- [DEFLATE Compression Algorithm](https://jnior.com/deflate-compression-algorithm/)
- [A better zip bomb](https://www.bamsoftware.com/hacks/zipbomb/)

